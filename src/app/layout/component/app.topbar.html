<div class="layout-topbar">
    <div class="layout-topbar-logo-container">
        <button class="layout-menu-button layout-topbar-action" (click)="layoutService.onMenuToggle()">
            <i class="pi pi-bars"></i>
        </button>
        <a class="layout-topbar-logo" routerLink="/">
            <img src="assets/favicon-32x32.png" alt="Caviar Scout" width="32" height="32" />
            <span>{{ 'topbar.title' | translate }}</span>
        </a>
    </div>

    <div class="layout-topbar-actions">
        <div class="layout-config-menu">
            <button type="button" class="layout-topbar-action" (click)="toggleDarkMode()">
                <i [ngClass]="{ 'pi ': true, 'pi-moon': layoutService.isDarkTheme(), 'pi-sun': !layoutService.isDarkTheme() }"></i>
            </button>
            <div class="relative">
                <button class="layout-topbar-action layout-topbar-action-highlight" pStyleClass="@next" enterFromClass="hidden" enterActiveClass="animate-scalein" leaveToClass="hidden" leaveActiveClass="animate-fadeout" [hideOnOutsideClick]="true">
                    <i class="pi pi-palette"></i>
                </button>
                <app-configurator></app-configurator>
            </div>
        </div>

        <button class="layout-topbar-menu-button layout-topbar-action" pStyleClass="@next" enterFromClass="hidden" enterActiveClass="animate-scalein" leaveToClass="hidden" leaveActiveClass="animate-fadeout" [hideOnOutsideClick]="true">
            <i class="pi pi-ellipsis-v"></i>
        </button>

        <div class="layout-topbar-menu hidden lg:block">
            <div class="layout-topbar-menu-content">
                <!-- Profile quick action -->
                <div class="relative">
                    <!-- Desktop: overlay panel -->
                    <ng-container *ngIf="!isMobile">
                        <button type="button" class="layout-topbar-action" (click)="toggleDesktopProfile($event)">
                            <i class="pi pi-user"></i>
                            <span>{{ profileDisplayName || ('topbar.profile.title' | translate) }}</span>
                        </button>

                        <p-overlayPanel #profileOverlay [dismissable]="true" [showCloseIcon]="false">
                            <div style="padding: 0.5rem 1rem; max-width: 260px flex flex-column">
                                <div style="font-weight: 600">{{ profileDisplayName || '—' }}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem">{{ profile?.email || '—' }}</div>
                                <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; justify-content: flex-end">
                                    <button pButton type="button" [label]="'topbar.profile.edit' | translate" icon="pi pi-user-edit" (click)="editProfile()" class="p-button-text p-button-secondary"></button>
                                    <button pButton type="button" [label]="'topbar.profile.logout' | translate" icon="pi pi-sign-out" (click)="logout()" class="p-button-text"></button>
                                    <button pButton type="button" [label]="'topbar.profile.delete' | translate" icon="pi pi-trash" (click)="showDeleteAccountDialog()" class="p-button-text p-button-danger"></button>
                                </div>
                            </div>
                        </p-overlayPanel>
                    </ng-container>

                    <!-- Mobile: open a right sidebar with profile + logout -->
                    <ng-container *ngIf="isMobile">
                        <button type="button" class="layout-topbar-action" (click)="toggleMobileProfile()">
                            <i class="pi pi-user"></i>
                        </button>

                        <p-sidebar [(visible)]="showMobileProfile" position="right" [baseZIndex]="10000" [modal]="true">
                            <div style="padding: 1rem; width: 260px">
                                <div style="font-weight: 600; font-size: 1rem">{{ profileDisplayName || '—' }}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem">{{ profile?.email || '—' }}</div>

                                <div style="margin-top: 1rem">
                                    <button pButton [label]="'topbar.profile.editMobile' | translate" icon="pi pi-user-edit" (click)="editProfile()" style="width: 100%" class="p-button-secondary p-button-outlined mb-2"></button>
                                    <button pButton [label]="'topbar.profile.logout' | translate" icon="pi pi-sign-out" (click)="logout()" style="width: 100%" class="p-button-outlined mb-2"></button>
                                    <button pButton [label]="'topbar.profile.deleteMobile' | translate" icon="pi pi-trash" (click)="showDeleteAccountDialog()" style="width: 100%" class="p-button-danger"></button>
                                </div>
                            </div>
                        </p-sidebar>
                    </ng-container>
                </div>

                <app-language-switcher></app-language-switcher>
            </div>
        </div>
    </div>

    <!-- Delete Account Confirmation Dialog -->
    <p-dialog [(visible)]="showDeleteConfirmDialog" [modal]="true" [closable]="!isDeletingAccount" [draggable]="false" [resizable]="false" [style]="{ width: '450px' }" [breakpoints]="{ '960px': '95vw', '640px': '90vw' }">
        <ng-template pTemplate="header">
            <div class="flex align-items-center gap-2">
                <i class="pi pi-exclamation-triangle text-red-500 text-2xl"></i>
                <span class="text-xl font-semibold">{{ 'topbar.profile.confirmDeleteTitle' | translate }}</span>
            </div>
        </ng-template>

        <div class="flex flex-column gap-4 py-3">
            <div class="text-center">
                <p class="text-lg mb-2">{{ 'topbar.profile.confirmDeleteMessage' | translate }}</p>
                <p class="text-sm text-500 m-0">{{ 'topbar.profile.confirmDeleteWarning' | translate }}</p>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-content-end gap-2">
                <button pButton type="button" [label]="'common.cancel' | translate" icon="pi pi-times" (click)="cancelDeleteAccount()" class="p-button-text" [disabled]="isDeletingAccount"></button>
                <button pButton type="button" [label]="'topbar.profile.deleteConfirm' | translate" icon="pi pi-trash" (click)="confirmDeleteAccount()" class="p-button-danger" [disabled]="isDeletingAccount" [loading]="isDeletingAccount"></button>
            </div>
        </ng-template>
    </p-dialog>

    <!-- Toast notifications -->
    <p-toast position="top-center" [baseZIndex]="99999"></p-toast>
</div>
