<div class="flex flex-col">
    <div class="card">
        <p-dataview #dv [value]="prodigies()" [layout]="layout" [rows]="6" [paginator]="true" [sortField]="sortField" [sortOrder]="sortOrder">
            <ng-template #header>
                <div class="flex justify-between flex-wrap gap-4">
                    <p-button [label]="'procrud.labels.newProdige' | translate" icon="pi pi-plus" severity="secondary" (onClick)="openNew()" />

                    <p-select [options]="sortOptions" [placeholder]="'procrud.sort.name.placeholder' | translate" (onChange)="onSortChange($event)" />

                    <p-select-button [(ngModel)]="layout" [options]="layoutOptions" [allowEmpty]="false">
                        <ng-template #item let-option>
                            <i class="pi" [ngClass]="{ 'pi-bars': option === 'list', 'pi-table': option === 'grid' }"></i>
                        </ng-template>
                    </p-select-button>
                </div>
            </ng-template>

            <ng-template #list let-items>
                <div class="flex flex-col">
                    <div *ngFor="let item of items; let i = index" class="p-6 border-b border-surface-200">
                        <div class="flex items-center gap-4">
                            <div class="flex-1 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div class="flex flex-col">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="text-xl font-medium cursor-pointer text-blue-600 underline" (click)="navigateToVideos(item.id)">{{ item.nom }}</div>
                                        <i [class]="getGenderIcon(item.genre)" class="text-sm"></i>
                                        <img [src]="'https://flagcdn.com/w20/' + (item.pays || 'fr').toLowerCase() + '.png'" [alt]="getCountryName(item.pays)" class="country-flag" *ngIf="item.pays" />
                                    </div>
                                    <div class="text-sm text-gray-500">{{ getSportLabel(item.sport) }}</div>
                                    <div class="flex items-center gap-2 mt-2">
                                        <p-tag [value]="item.age + ' ' + ('shared.common.years' | translate)" [severity]="getAgeSeverity(item.age)" />
                                        <span class="text-xs text-gray-500">{{ getCountryName(item.pays) }}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <div class="flex flex-wrap gap-1">
                                        <p-tag *ngFor="let tag of item.tags?.slice(0, 3)" [value]="getTagLabel(tag)" severity="info" class="text-xs" />
                                        <p-tag *ngIf="(item.tags?.length || 0) > 3" [value]="'+' + ((item.tags?.length || 0) - 3)" severity="secondary" class="text-xs" />
                                    </div>
                                    <span class="text-sm text-gray-500 mt-2">{{ item.dateCreation | date: 'dd/MM/yyyy' }}</span>
                                    <div class="flex gap-2">
                                        <p-button icon="pi pi-pencil" [rounded]="true" [outlined]="true" (click)="editProdige(item)" />
                                        <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteProdige(item)" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>

            <ng-template #grid let-items>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div *ngFor="let item of items; let i = index" class="p-4 border rounded shadow-sm flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-lg cursor-pointer text-blue-600 underline" (click)="navigateToVideos(item.id)">{{ item.nom }}</span>
                                <i [class]="getGenderIcon(item.genre)" class="text-sm"></i>
                            </div>
                            <div class="flex items-center gap-2">
                                <p-tag [value]="item.age + ' ' + ('shared.common.years' | translate)" [severity]="getAgeSeverity(item.age)" />
                                <img [src]="'https://flagcdn.com/w20/' + (item.pays || 'fr').toLowerCase() + '.png'" [alt]="getCountryName(item.pays)" class="country-flag" *ngIf="item.pays" />
                            </div>
                        </div>

                        <div class="flex-grow flex flex-col gap-2">
                            <div class="text-sm text-gray-500">{{ getSportLabel(item.sport) }}</div>
                            <div class="flex flex-wrap gap-1">
                                <p-tag *ngFor="let tag of item.tags?.slice(0, 3)" [value]="getTagLabel(tag)" severity="info" class="text-xs" />
                                <p-tag *ngIf="(item.tags?.length || 0) > 3" [value]="'+' + ((item.tags?.length || 0) - 3)" severity="secondary" class="text-xs" />
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-4">
                            <span class="text-sm text-gray-500">{{ item.dateCreation | date: 'dd/MM/yyyy' }}</span>
                            <div class="flex gap-2">
                                <p-button icon="pi pi-pencil" [rounded]="true" [outlined]="true" (click)="editProdige(item)" />
                                <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteProdige(item)" />
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>
        </p-dataview>
    </div>
</div>

<p-dialog [(visible)]="prodigeDialog" [style]="{ width: '450px' }" [header]="'procrud.labels.prodigeDetails' | translate" [modal]="true">
    <ng-template #content>
        <div class="flex flex-col gap-6">
            <div>
                <label for="nom" class="block font-bold mb-3">
                    {{ 'shared.common.name' | translate }}
                    <span class="text-red-500">{{ 'shared.common.required' | translate }}</span>
                </label>
                <input type="text" pInputText id="nom" [(ngModel)]="prodige.nom" required autofocus fluid />
                <small class="text-red-500" *ngIf="submitted && !prodige.nom">
                    {{ 'shared.validation.nameRequired' | translate }}
                </small>
            </div>

            <div>
                <label for="age" class="block font-bold mb-3">
                    {{ 'shared.common.age' | translate }}
                    <span class="text-red-500">{{ 'shared.common.required' | translate }}</span>
                </label>
                <p-inputnumber id="age" [(ngModel)]="prodige.age" [min]="5" [max]="25" fluid />
                <small class="text-red-500" *ngIf="submitted && !prodige.age">
                    {{ 'shared.validation.ageRequired' | translate }}
                </small>
            </div>

            <div>
                <label class="block font-bold mb-3">
                    {{ 'procrud.columns.genre' | translate }}
                    <span class="text-red-500">{{ 'shared.common.required' | translate }}</span>
                </label>
                <div class="flex gap-4">
                    <div class="flex items-center">
                        <p-radiobutton [(ngModel)]="prodige.genre" [value]="1" inputId="male" name="genre" />
                        <label for="male" class="ml-2">
                            <i class="pi pi-mars mr-1"></i>
                            {{ 'shared.common.male' | translate }}
                        </label>
                    </div>
                    <div class="flex items-center">
                        <p-radiobutton [(ngModel)]="prodige.genre" [value]="2" inputId="female" name="genre" />
                        <label for="female" class="ml-2">
                            <i class="pi pi-venus mr-1"></i>
                            {{ 'shared.common.female' | translate }}
                        </label>
                    </div>
                </div>
                <small class="text-red-500" *ngIf="submitted && prodige.genre === undefined">
                    {{ 'shared.validation.genderRequired' | translate }}
                </small>
            </div>

            <div>
                <label for="country" class="block font-bold mb-3">
                    {{ 'procrud.columns.country' | translate }}
                    <span class="text-red-500">{{ 'shared.common.required' | translate }}</span>
                </label>
                <p-select [options]="countries" class="w-full" [(ngModel)]="prodige.pays" optionLabel="name" optionValue="code" placeholder="Select a country" [filter]="true" [virtualScroll]="true" [itemSize]="40" [showClear]="true">
                    <!-- Template for each item in the dropdown -->
                    <ng-template let-country pTemplate="item">
                        <div class="flex align-items-center gap-2">
                            <span>{{ country.flag }}</span>
                            <span>{{ country.name }}</span>
                        </div>
                    </ng-template>

                    <!-- Template for selected item -->
                    <ng-template pTemplate="selectedItem">
                        <ng-container *ngIf="getSelectedCountry(); else noSelection">
                            <div class="flex align-items-center gap-2">
                                <span>{{ getSelectedCountry()?.flag }}</span>
                                <span>{{ getSelectedCountry()?.name }}</span>
                            </div>
                        </ng-container>
                        <ng-template #noSelection>
                            <span>Select a country</span>
                        </ng-template>
                    </ng-template>
                </p-select>

                <small class="text-red-500" *ngIf="submitted && !prodige.pays">
                    {{ 'shared.validation.countryRequired' | translate }}
                </small>
            </div>

            <div>
                <label for="description" class="block font-bold mb-3">
                    {{ 'shared.common.description' | translate }}
                    <span *ngIf="isDescriptionRequired()" class="text-red-500">{{ 'shared.common.required' | translate }}</span>
                </label>
                <textarea id="description" pTextarea [(ngModel)]="prodige.description" rows="3" cols="20" [placeholder]="getDescriptionPlaceholder()" fluid> </textarea>
                <small class="text-red-500" *ngIf="submitted && isDescriptionRequired() && (!prodige.description || !prodige.description.trim())">
                    {{ 'procrud.validation.descriptionRequired' | translate }}
                </small>
            </div>

            <div>
                <label for="sport" class="block font-bold mb-3">
                    {{ 'procrud.labels.sport' | translate }}
                    <span class="text-red-500">{{ 'shared.common.required' | translate }}</span>
                </label>
                <p-select [(ngModel)]="prodige.sport" inputId="sport" [options]="sportOptions" optionLabel="label" optionValue="value" [placeholder]="'procrud.labels.selectSport' | translate" appendTo="body" fluid />
                <small class="text-red-500" *ngIf="submitted && prodige.sport === undefined">
                    {{ 'procrud.validation.sportRequired' | translate }}
                </small>
            </div>

            <div>
                <label class="block font-bold mb-3">
                    {{ 'shared.common.tags' | translate }} {{ 'procrud.tags.minMaxInfo' | translate }}
                    <span class="text-red-500">{{ 'shared.common.required' | translate }}</span>
                </label>

                <div class="flex flex-wrap gap-2 mb-3" *ngIf="prodige.tags && prodige.tags.length > 0">
                    <p-chip *ngFor="let tag of prodige.tags" [label]="getTagLabel(tag)" [removable]="true" (onRemove)="removeTag(tag)" />
                </div>

                <div class="flex gap-2 mb-3">
                    <p-select
                        [(ngModel)]="selectedTagToAdd"
                        [options]="getAvailableTags()"
                        optionLabel="label"
                        optionValue="value"
                        [placeholder]="'procrud.labels.addTag' | translate"
                        appendTo="body"
                        [style]="{ 'min-width': '200px' }"
                        [disabled]="(prodige.tags?.length || 0) >= 10"
                    />
                    <p-button icon="pi pi-plus" (click)="addTag()" [disabled]="!selectedTagToAdd || (prodige.tags?.length || 0) >= 10" severity="secondary" size="small" />
                </div>

                <small class="text-gray-600">
                    {{ 'procrud.tags.selectedCount:count:' + (prodige.tags?.length || 0) | translateParams }}
                </small>
                <small class="text-red-500 block" *ngIf="submitted && (!prodige.tags || prodige.tags.length < 3)">
                    {{ 'procrud.validation.minTagsRequired' | translate }}
                </small>
            </div>

            <div *ngIf="prodige.videos && prodige.videos.length > 0">
                <label class="block font-bold mb-3">{{ 'procrud.labels.associatedVideos' | translate }}</label>
                <div class="border border-gray-200 rounded p-3">
                    <div *ngFor="let video of prodige.videos" class="flex items-center gap-2 mb-2">
                        <i class="pi pi-video text-blue-500"></i>
                        <span>{{ video.titre || ('procrud.labels.videoWithoutTitle' | translate) }}</span>
                    </div>
                    <small class="text-gray-500">
                        {{ 'procrud.tags.associatedVideosCount:count:' + prodige.videos.length | translateParams }}
                    </small>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button [label]="'shared.actions.cancel' | translate" icon="pi pi-times" text (click)="hideDialog()" />
        <p-button [label]="'shared.actions.save' | translate" icon="pi pi-check" (click)="saveProdige()" />
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />

<p-toast />
