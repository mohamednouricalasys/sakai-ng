<!-- Hero Header Section -->
<div class="app-hero">
    <div class="app-hero-content">
        <div class="app-hero-title-section">
            <div class="app-hero-icon">
                <i class="pi pi-video"></i>
            </div>
            <div class="app-hero-text">
                <h1 class="app-hero-title">{{ 'video.labels.myVideos' | translate }}</h1>
                <p class="app-hero-subtitle">{{ 'video.labels.manageYourVideos' | translate }}</p>
            </div>
        </div>

        <button
            class="app-add-btn"
            (click)="openNew()"
            [disabled]="hasReachedVideoLimit() || !selectedProdige()"
            [title]="hasReachedVideoLimit() ? ('video.messages.limitReached' | translate) : !selectedProdige() ? ('video.messages.selectProdigeFirst' | translate) : ''"
        >
            <i class="pi pi-plus"></i>
            <span>{{ 'video.labels.newVideo' | translate }}</span>
        </button>
    </div>
</div>

<!-- Loading State -->
<div *ngIf="loading()" class="app-loading-section">
    <div class="app-loading-content">
        <div class="app-loading-spinner"></div>
        <span class="app-loading-text">{{ 'shared.common.loading' | translate }}</span>
    </div>
</div>

<!-- Controls Section -->
<div *ngIf="!loading()" class="app-controls-section">
    <div class="app-controls-card">
        <!-- Prodige Selector -->
        <div class="app-control-row">
            <div class="app-control-group app-prodige-control">
                <label class="app-control-label">
                    <i class="pi pi-user"></i>
                    {{ 'video.labels.prodige' | translate }}
                </label>
                <p-select [options]="prodiges()" [(ngModel)]="selectedProdige" optionLabel="nom" (onChange)="onProdigeChange($event)" [placeholder]="'video.labels.selectProdige' | translate" styleClass="app-select-modern" />
            </div>

            <div class="app-control-group app-sort-control">
                <label class="app-control-label">
                    <i class="pi pi-sort-alt"></i>
                    {{ 'video.sort.title.label' | translate }}
                </label>
                <p-select [options]="sortOptions" [placeholder]="'video.sort.title.placeholder' | translate" (onChange)="onSortChange($event)" styleClass="app-select-modern" />
            </div>

            <div class="app-layout-toggle-wrapper">
                <div class="app-layout-toggle">
                    <button class="app-layout-btn" [class.active]="layout === 'list'" (click)="layout = 'list'">
                        <i class="pi pi-bars"></i>
                    </button>
                    <button class="app-layout-btn" [class.active]="layout === 'grid'" (click)="layout = 'grid'">
                        <i class="pi pi-th-large"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Limit Progress -->
        <div *ngIf="selectedProdige()" class="app-progress-section">
            <div class="app-progress-header">
                <div class="app-progress-info">
                    <i class="pi pi-chart-bar"></i>
                    <span>{{ 'video.limits.usage' | translate }}</span>
                </div>
                <div class="app-progress-count" [class.app-limit-reached]="hasReachedVideoLimit()">{{ videos().length }} / {{ MAX_VIDEOS_PER_PRODIGY }}</div>
            </div>
            <div class="app-progress-bar">
                <div class="app-progress-fill" [style.width.%]="(videos().length / MAX_VIDEOS_PER_PRODIGY) * 100" [class.warning]="videos().length >= MAX_VIDEOS_PER_PRODIGY * 0.8" [class.danger]="hasReachedVideoLimit()"></div>
            </div>
            <span class="app-progress-text" [class.app-limit-warning]="hasReachedVideoLimit()">
                <i class="pi" [class.pi-check-circle]="!hasReachedVideoLimit()" [class.pi-exclamation-triangle]="hasReachedVideoLimit()"></i>
                {{ getRemainingVideoSlots() }} {{ 'video.limits.slotsRemaining' | translate }}
            </span>
        </div>
    </div>
</div>

<!-- Main Content -->
<div *ngIf="!loading()" class="app-content-section">
    <p-dataview #dv [value]="videos()" [layout]="layout" [rows]="6" [paginator]="true" [sortField]="sortField" [sortOrder]="sortOrder" styleClass="app-dataview">
        <!-- List View -->
        <ng-template #list let-items>
            <div class="app-list-container">
                <div *ngFor="let item of items; let i = index" class="app-list-item" [style.animation-delay]="i * 0.05 + 's'">
                    <div class="app-list-item-content">
                        <!-- Video Thumbnail -->
                        <div class="app-list-thumbnail">
                            <div class="app-video-player-wrapper">
                                <video *ngIf="showVideo && item?.fileItem?.url" #videoElement [attr.id]="'video-' + item.id" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="metadata" [src]="item?.fileItem?.url"></video>
                                <div *ngIf="!item?.fileItem?.url" class="app-video-placeholder">
                                    <i class="pi pi-video"></i>
                                    <span>{{ 'video.labels.noPreview' | translate }}</span>
                                </div>
                            </div>
                            <!-- Status Badge -->
                            <div class="app-status-badge-overlay">
                                <span class="app-status-badge" [class]="getStatusClass(item.statutModeration)">
                                    {{ getVideoStatusLabel(item.statutModeration) }}
                                </span>
                            </div>
                        </div>

                        <!-- Video Info -->
                        <div class="app-list-info">
                            <div class="app-info-header">
                                <h3 class="app-item-title">{{ item.titre }}</h3>
                                <div class="moderation-indicator" *ngIf="item.commentaireModeration && (item.statutModeration === statutModeration.Approuvee || item.statutModeration === statutModeration.Rejetee)">
                                    <button class="info-btn" (click)="popover.toggle($event)">
                                        <i class="pi pi-info-circle"></i>
                                    </button>
                                    <p-popover #popover [dismissable]="true" [styleClass]="'moderation-popover ' + (item.statutModeration === statutModeration.Rejetee ? 'rejected' : 'approved')">
                                        <ng-template pTemplate="content">
                                            <div [innerHTML]="getModerationTooltipContent(item)"></div>
                                        </ng-template>
                                    </p-popover>
                                </div>
                            </div>
                            <p class="app-item-description">{{ item.description || ('video.labels.noDescription' | translate) }}</p>
                            <div class="app-meta">
                                <span class="app-meta-item date">
                                    <i class="pi pi-calendar"></i>
                                    {{ item.dateCreation || item.createdAt | date: 'dd MMM yyyy' }}
                                </span>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="app-list-actions">
                            @if (item.statutModeration !== statutModeration.Approuvee) {
                                <button class="app-action-btn edit" (click)="editVideo(item)" [title]="'shared.actions.edit' | translate">
                                    <i class="pi pi-pencil"></i>
                                </button>
                            }
                            <button class="app-action-btn delete" (click)="deleteVideo(item)" [title]="'shared.actions.delete' | translate">
                                <i class="pi pi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </ng-template>

        <!-- Grid View -->
        <ng-template #grid let-items>
            <div class="app-grid-container">
                <div *ngFor="let item of items; let i = index" class="app-card-wrapper" [style.animation-delay]="i * 0.05 + 's'">
                    <div class="app-card">
                        <!-- Video Player Section -->
                        <div class="app-card-media">
                            <div class="app-video-player-wrapper">
                                <video *ngIf="showVideo && item?.fileItem?.url" #videoElement [attr.id]="'video-' + item.id" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="metadata" [src]="item?.fileItem?.url"></video>
                                <div *ngIf="!item?.fileItem?.url" class="app-video-placeholder">
                                    <i class="pi pi-video"></i>
                                    <span>{{ 'video.labels.noPreview' | translate }}</span>
                                </div>
                            </div>
                            <!-- Status Badge Overlay -->
                            <div class="app-status-badge-overlay">
                                <span class="app-status-badge" [class]="getStatusClass(item.statutModeration)">
                                    {{ getVideoStatusLabel(item.statutModeration) }}
                                </span>
                            </div>
                        </div>

                        <!-- Card Content -->
                        <div class="app-card-content">
                            <div class="app-card-header">
                                <h3 class="app-item-title">{{ item.titre }}</h3>
                                <div class="moderation-indicator" *ngIf="item.commentaireModeration && (item.statutModeration === statutModeration.Approuvee || item.statutModeration === statutModeration.Rejetee)">
                                    <button class="info-btn" (click)="popover.toggle($event)">
                                        <i class="pi pi-info-circle"></i>
                                    </button>
                                    <p-popover #popover [dismissable]="true" [styleClass]="'moderation-popover ' + (item.statutModeration === statutModeration.Rejetee ? 'rejected' : 'approved')">
                                        <ng-template pTemplate="content">
                                            <div [innerHTML]="getModerationTooltipContent(item)"></div>
                                        </ng-template>
                                    </p-popover>
                                </div>
                            </div>

                            <p class="app-item-description">{{ item.description || ('video.labels.noDescription' | translate) }}</p>

                            <div class="app-card-footer">
                                <span class="app-item-date">
                                    <i class="pi pi-calendar"></i>
                                    {{ item.dateCreation || item.createdAt | date: 'dd MMM yyyy' }}
                                </span>
                                <div class="app-card-actions">
                                    @if (item.statutModeration !== statutModeration.Approuvee) {
                                        <button class="app-action-btn edit" (click)="editVideo(item)" [title]="'shared.actions.edit' | translate">
                                            <i class="pi pi-pencil"></i>
                                        </button>
                                    }
                                    <button class="app-action-btn delete" (click)="deleteVideo(item)" [title]="'shared.actions.delete' | translate">
                                        <i class="pi pi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ng-template>

        <!-- Empty State -->
        <ng-template #empty>
            <div class="app-empty-state">
                <div class="app-empty-illustration">
                    <div class="app-empty-circle">
                        <i class="pi pi-video"></i>
                    </div>
                    <div class="app-empty-decorations">
                        <span class="app-decoration d1"></span>
                        <span class="app-decoration d2"></span>
                        <span class="app-decoration d3"></span>
                    </div>
                </div>
                <h2 class="app-empty-title">{{ 'video.empty.title' | translate }}</h2>
                <p class="app-empty-description">
                    {{ selectedProdige() ? ('video.empty.description' | translate) : ('video.empty.selectProdige' | translate) }}
                </p>
                <button *ngIf="selectedProdige() && !hasReachedVideoLimit()" class="app-empty-action-btn" (click)="openNew()">
                    <i class="pi pi-plus"></i>
                    {{ 'video.labels.addFirstVideo' | translate }}
                </button>
            </div>
        </ng-template>
    </p-dataview>
</div>

<!-- Video Dialog -->
<p-dialog
    [(visible)]="videoDialog"
    [style]="{ width: '90vw', 'max-width': '720px' }"
    [header]="video.id ? ('video.labels.editVideo' | translate) : ('video.labels.newVideo' | translate)"
    [modal]="true"
    [closable]="!saving()"
    [closeOnEscape]="!saving()"
    styleClass="app-dialog-modern"
>
    <ng-template #content>
        <div class="app-dialog-body">
            <!-- Guidelines Panel -->
            <div class="app-info-panel" [class.collapsed]="guidelinesCollapsed">
                <div class="app-panel-header" (click)="guidelinesCollapsed = !guidelinesCollapsed">
                    <div class="app-panel-title">
                        <i class="pi pi-shield"></i>
                        <span>{{ 'video.guidelines.title' | translate }}</span>
                    </div>
                    <i class="pi chevron-icon" [class.pi-chevron-down]="guidelinesCollapsed" [class.pi-chevron-up]="!guidelinesCollapsed"></i>
                </div>
                <div class="app-panel-content" *ngIf="!guidelinesCollapsed">
                    <div class="app-panel-item">
                        <div class="app-panel-icon">
                            <i class="pi pi-eye-slash"></i>
                        </div>
                        <span>{{ 'video.guidelines.hideIdentity' | translate }}</span>
                    </div>
                    <div class="app-panel-item">
                        <div class="app-panel-icon success">
                            <i class="pi pi-check-circle"></i>
                        </div>
                        <span>{{ 'video.guidelines.athleteConsent' | translate }}</span>
                    </div>
                    <div class="app-panel-item">
                        <div class="app-panel-icon info">
                            <i class="pi pi-video"></i>
                        </div>
                        <span>{{ 'video.guidelines.prodigyOnly' | translate }}</span>
                    </div>
                    <div class="app-panel-item">
                        <div class="app-panel-icon danger">
                            <i class="pi pi-ban"></i>
                        </div>
                        <span>{{ 'video.guidelines.noPersonalInfo' | translate }}</span>
                    </div>
                </div>
            </div>

            <!-- Form Fields -->
            <div class="app-form-section">
                <!-- Title -->
                <div class="app-form-field">
                    <label for="titre" class="app-form-label">
                        {{ 'shared.common.title' | translate }}
                        <span class="required">*</span>
                    </label>
                    <div class="app-input-wrapper">
                        <i class="pi pi-tag app-input-icon"></i>
                        <input pInputText id="titre" type="text" [(ngModel)]="video.titre" required autofocus [disabled]="saving()" [placeholder]="'video.placeholders.title' | translate" class="app-form-input" />
                    </div>
                    <small class="app-form-error" *ngIf="submitted && !video.titre">
                        <i class="pi pi-exclamation-circle"></i>
                        {{ 'shared.validation.titleRequired' | translate }}
                    </small>
                </div>

                <!-- Description -->
                <div class="app-form-field">
                    <label for="description" class="app-form-label">
                        {{ 'shared.common.description' | translate }}
                        <span class="required">*</span>
                    </label>
                    <textarea id="description" pTextarea [(ngModel)]="video.description" rows="4" [disabled]="saving()" [placeholder]="'video.placeholders.description' | translate" required class="app-form-textarea"></textarea>
                    <small class="app-form-error" *ngIf="submitted && !video.description">
                        <i class="pi pi-exclamation-circle"></i>
                        {{ 'video.validation.descriptionRequired' | translate }}
                    </small>
                </div>

                <!-- File Upload Section -->
                <div class="app-form-field">
                    <label class="app-form-label">
                        {{ 'video.labels.videoFile' | translate }}
                        <span class="required" *ngIf="!video.id">*</span>
                        <span class="app-optional-tag" *ngIf="video.id">{{ 'video.labels.optionalForEdit' | translate }}</span>
                    </label>

                    <!-- Current file info for editing -->
                    <div *ngIf="video.id && video.fileItem" class="app-file-display">
                        <div class="app-file-icon">
                            <i class="pi pi-file-edit"></i>
                        </div>
                        <div class="app-file-info">
                            <span class="app-file-label">{{ 'video.labels.currentFile' | translate }}</span>
                            <span class="app-file-name">{{ video.fileItem.name }}</span>
                        </div>
                    </div>

                    @if (!saving()) {
                        <div class="uploader-container">
                            <app-mp4-uploader [maxFiles]="1" [maxFileSize]="500 * 1024 * 1024" [allowedFileTypes]="['video/*']" (fileUploaded)="onFileUploaded($event)" (fileRemoved)="onFileRemoved($event)" />
                        </div>
                    }

                    <small class="app-form-error" *ngIf="submitted && !video.fileItemId && !uploadedFile && !video.id">
                        <i class="pi pi-exclamation-circle"></i>
                        {{ 'video.validation.videoRequired' | translate }}
                    </small>

                    <small class="app-form-hint" *ngIf="uploadedFile">
                        <i class="pi pi-info-circle"></i>
                        {{ 'video.info.newFileWillReplace' | translate }}
                    </small>
                </div>
            </div>

            <!-- Saving Indicator -->
            <div *ngIf="saving()" class="app-saving-overlay">
                <div class="app-saving-content">
                    <div class="app-saving-spinner"></div>
                    <span>{{ 'shared.common.saving' | translate }}</span>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <div class="app-dialog-actions">
            <button class="app-dialog-btn secondary" (click)="hideDialog()" [disabled]="saving()">
                <i class="pi pi-times"></i>
                {{ 'shared.actions.cancel' | translate }}
            </button>
            <button class="app-dialog-btn primary" (click)="saveVideo()" [disabled]="saving() || !video.titre?.trim() || !video.description?.trim() || (!video.id && !uploadedFile)">
                <i class="pi" [class.pi-spinner]="saving()" [class.pi-spin]="saving()" [class.pi-check]="!saving()"></i>
                {{ 'shared.actions.save' | translate }}
            </button>
        </div>
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />
<p-toast />
